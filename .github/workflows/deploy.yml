# 工作流名称
name: Auto Deploy GitHub.io Blog

# 触发条件：向 main 分支推送代码时触发
on:
  push:
    branches:
      - main

# 工作流任务
jobs:
  deploy:
    # 运行环境：最新版 Ubuntu
    runs-on: ubuntu-latest
    steps:
      # 步骤1：拉取仓库代码到运行环境
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 拉取所有历史提交（部分主题需要）

      # 步骤2：设置 Node.js 环境
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm' # 缓存 npm 依赖，加速后续构建

      # 步骤3：安装依赖（VitePress 专用）
      - name: Install dependencies
        run: |
          npm install
          npm install -g vitepress

      # 步骤4：构建静态文件（VitePress 正确命令）
      - name: Build static files
        run: npm run docs:build # 修复：命令直接写在一行，删除多余注释

      # 步骤5：部署到 dist 分支（修复缩进+语法）
      - name: Deploy with token
        env:
          DEPLOY_TOKEN: ${{ secrets.ACCESS_TOKEN }}
          REPO: github.com/booms21/booms21.github.io.git
          BRANCH: dist
        run: |
          # 基础配置（必须：用户名/邮箱与GitHub账号一致）
          git config --global user.name "booms21"
          git config --global user.email "949487862@qq.com"

          # 进入 VitePress 构建后的静态文件目录
          cd ./docs/.vitepress/dist

          # 初始化git仓库并推送
          git init
          git add -A
          git commit -m "Auto deploy: ${{ github.event.head_commit.message }}"
          # 关键：用Token拼接URL传递权限，强制推送覆盖dist分支
          git push -f https://booms21:${DEPLOY_TOKEN}@${REPO} master:${BRANCH}
